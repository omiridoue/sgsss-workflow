---
title: Auxiliary Tools
teaching: 15
exercises: 10
---

::::::::::::::::::::::::::::::::::::::: objectives

- Understand how to reproduce code.
- Understand the benefits of containers.

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

- When should I use a pre-built container?
- How can I customise a container?
- What is a remote codespace?

::::::::::::::::::::::::::::::::::::::::::::::::::


::: group 

### Browsing Docker Hub

- The container image is updated regularly, the latest version should be available alongside previous versions.
- The container image associated with a well established company, community, or other group that is well-known.
- There is a Dockerfile or other listing of what has been installed to the container image.
- The container image page has documentation on how to use the container image.

:::::::::::::::::::::::::::::::::::::::: discussion

If a container image is never updated, and does not have a lot of metadata, it is probably worth skipping over. Even if such a container image is secure, it is not reproducible and not a dependable way to run research computations.

::::::::::::::::::::::::::::

### Docker Recipe File

Much like a cookbook, you can pull out recipes and alter to own preference. This is how you normally get started building your own image, you can start with a base repository, i.e installation instructions for one or more software, and layer requirements, i.e code libraries.

``` docker

FROM bioconductor/bioconductor_docker:devel-R-4.4.1

RUN R -e "install.packages(c('Matrix', 'lattice', 'parallel', 'MASS', 'methods', 'xtable', 'network', 'vioplot', 'sna', 'codetools', 'dplyr', 'metafor', 'argparse', 'stringr', 'mixmeta'), repos = c(CRAN = 'https://cloud.r-project.org'))"

COPY rsiena_1.4.19.tar.gz .

RUN R -e "install.packages('rsiena_1.4.19.tar.gz', repos = NULL, type = 'source')"

```

## Workflow

Within our workflow we can specify the container we want to use, as a matter of fact we can specify a container for different processes - the possibility is endless! Say for example you would like to write interoperable code and use Python for one part of your analysis and R for another part, this is possible by defining a different container for each process. Another option is to build one container with all the software (i.e R and Python) installed.

Say we work with one container, but would like to make sure the pipeline is portable. In this case we work with profiles, which is another layer for customisation.

:::

## Containers in Profile

Many container platforms are available, but Apptainer is designed for ease-of-use on shared systems and in high performance computing (HPC) environments. Nextflow can build an immutable image based off a Docker recipe file.

::: group

### Building an Apptainer Image

``` bash
singularity pull docker://omiridoue-siena_r:0.8

```

### Workflow Definition

Within our workflow, we can declare a process container, and ensure we enable apptainer. Again we don't want to hard code this decision as we'd like to keep options as flexible as possible. This is why we build a profile for each our compute environments, in this case for our local machine / GitHub codespace we have access to Docker. However, for our slurm profile, relevant to a computer cluster with Slurm workload manager, we opt for apptainer (former singularity), as docker is not available.

:::::::::::::::::::::::::::: challenge

We can declare a different config file for different compute environments, or profiles. These profiles are stored under the conf sub-folder. 

::::::::: solution
```
profiles {

  local {
    includeConfig 'conf/local.config'
    process.container = 'omiridoue/siena_r:0.8'
  }
  slurm {
    includeConfig 'conf/slurm.config'
    process.executor = 'slurm'
    process.container = 'omiridoue/siena_r:0.8'
  }
}
```

:::::::::::::::::
::::::::::::::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::: keypoints

- The Docker Hub is an online repository of container images.
- Find a container recipe file that works for your project and customise this.
- Nextflow can pull a docker container from Docker Hub and convert this to an Apptainer image.
- Docker is not permitted on most HPC environments, apptainer sif files are used instead.
- Containers are important to reproducible workflows and portability of workflows across environments.

::::::::::::::::::::::::::::::::::::::::::::::::::